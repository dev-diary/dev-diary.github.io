<!-- This layout is used in all pages. Making changes here will efect all pages. We recommend not to change anything here. --> <!DOCTYPE html><html lang="en"> <!----><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="google-site-verification" content="Cghc1HFx2GBn1D5ans5vLlaX-pme-BY2wJpaLqHs_H0" /><meta name=”keywords” content=”java, openshift, docker, Michal Fabjanski, Fabjanski, github, jekyll, programming, spring, hibernate, spring boot, kubernetes” /><link rel="dns-prefetch" href="//fonts.googleapis.com"><link rel="dns-prefetch" href="//google-analytics.com"><link rel="dns-prefetch" href="//www.google-analytics.com"><link rel="dns-prefetch" href="//maxcdn.bootstrapcdn.com"><link rel="dns-prefetch" href="//ajax.googleapis.com"><link rel="dns-prefetch" href="//fonts.gstatic.com"><link rel="dns-prefetch" href="https://dev-diary-2.disqus.com/"><title>Metrics from unstructured logs on Kubernetes. Sidecar pattern with gork exporter - Part 2 | Devdiaries</title><meta name="generator" content="Jekyll v3.8.4" /><meta property="og:title" content="Metrics from unstructured logs on Kubernetes. Sidecar pattern with gork exporter - Part 2" /><meta name="author" content="Michal Fabjanski" /><meta property="og:locale" content="en_US" /><meta name="description" content="In previous post, you have looked into Prometheus basics. In this part, it is time to create Prometheus service on the Kubernetes which can scrape metrics from additional metric exporter. It’s the perfect solution when you can’t export metrics from the application source code and your application logs the information you want to expose as metrics." /><meta property="og:description" content="In previous post, you have looked into Prometheus basics. In this part, it is time to create Prometheus service on the Kubernetes which can scrape metrics from additional metric exporter. It’s the perfect solution when you can’t export metrics from the application source code and your application logs the information you want to expose as metrics." /><link rel="canonical" href="https://www.devdiaries.net/blog/Prometheus-On-Kubernetes-Part-2/" /><meta property="og:url" content="https://www.devdiaries.net/blog/Prometheus-On-Kubernetes-Part-2/" /><meta property="og:site_name" content="Devdiaries" /><meta property="og:image" content="https://www.devdiaries.net/images/prometheus-kubernetes/prometheus-kubernetes2.jpg" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2019-08-31T00:00:00+00:00" /><script type="application/ld+json"> {"image":"https://www.devdiaries.net/images/prometheus-kubernetes/prometheus-kubernetes2.jpg","description":"In previous post, you have looked into Prometheus basics. In this part, it is time to create Prometheus service on the Kubernetes which can scrape metrics from additional metric exporter. It’s the perfect solution when you can’t export metrics from the application source code and your application logs the information you want to expose as metrics.","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.devdiaries.net/blog/Prometheus-On-Kubernetes-Part-2/"},"@type":"BlogPosting","datePublished":"2019-08-31T00:00:00+00:00","url":"https://www.devdiaries.net/blog/Prometheus-On-Kubernetes-Part-2/","author":{"@type":"Person","name":"Michal Fabjanski"},"headline":"Metrics from unstructured logs on Kubernetes. Sidecar pattern with gork exporter - Part 2","dateModified":"2019-08-31T00:00:00+00:00","@context":"https://schema.org"}</script><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"> <!-- Replace these icons with your own. --><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/apple-icon-152x152.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/android-icon-192x192.png"><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"><link rel="icon" href="/favicon.ico" type="image/x-icon"><link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet"> <!-- Google Analytics code.<head> tag is the right place for analytics code as directed by Google. This is unofficial light version which loads blazing fast! Implemented for faster page load. --><script src="https://cdn.jsdelivr.net/npm/ga-lite@1/dist/ga-lite.min.js" async></script><script> var galite = galite || {}; galite.UA = 'UA-139553005-1';</script><script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.bundle.min.js"></script></head><body><div class="loader"><div class="lds-ring"><div></div><div></div><div></div><div></div></div></div><div class="wrapper"><div class="container-grid"><div class="sidebar"><div class="author-container shadow"><div class="author"><img src="/images/ja.jpg" width="100%" height="auto;" alt="Devdiaries" onclick="location.href='/'"></div><div class="about text-center"><h1 class="title"><a href="/">Devdiaries</a></h1></div><div class="bio text-center"><p class="m0">Michael`s Blog</p></div><hr class="dashed"><div class="social text-center"> <ul class="portfolio p0"> <li><a href="/about/">About Me</a></li> <li><a href="/categories/">Categories</a></li> <li><a href="/contact/">Contact</a></li> </ul> <ul class="sm p0 m0a"> <li><a href="https://www.linkedin.com/in/michal-fabjanski"><i class="fa fa-linkedin"></i></a></li> <li><a href="https://github.com"><i class="fa fa-github"></i></a></li> </ul></div></div></div><div class="main"><div class="main-container shadow"><div class="title-space"> <h2>Metrics from unstructured logs on Kubernetes. Sidecar pattern with gork exporter - Part 2</h2></div><hr class="dashed"> <main> <ul class="breadcrumbs"> <li><a href="/">Home</a></li> <li><a href="/blog/">Blog</a></li> <li><a href="#">Prometheus on kub...</a></li> </ul><div class="meta"> <p> <small> <span> <i class="fa fa-calendar" aria-hidden="true"></i> 31 Aug 2019&nbsp; </span> <span> <i class="fa fa-user" aria-hidden="true"></i> Michal Fabjanski&nbsp; </span> <span> <i class="fa fa-clock-o" aria-hidden="true"></i> 8 mins read. </span> </small> </p></div><div class="featured-image" style="background-image: url(/images/prometheus-kubernetes/prometheus-kubernetes2.jpg)"></div><article> <ul class="toc rev clearfix"> <li><a href="#example-spring-application-with-logging">Example Spring application with logging</a></li> <li><a href="#deploy-a-spring-boot-application-on-kubernetes">Deploy a Spring Boot Application on Kubernetes</a></li> <li><a href="#deploy-a-gork-exporter-as-a-sidecar-on-kubernetes">Deploy a Gork Exporter as a sidecar on Kubernetes</a> <ul> <li><a href="#log-capture-using-gork-exporter-in-kubernetes">Log capture using gork exporter in Kubernetes</a></li> </ul> </li> <li><a href="#deploy-a-prometheus-on-kubernetes">Deploy a Prometheus on Kubernetes</a> <ul> <li><a href="#prometheus-configmap">Prometheus ConfigMap</a></li> <li><a href="#prometheus-deployment">Prometheus Deployment</a></li> <li><a href="#prometheus-service">Prometheus Service</a></li> </ul> </li> <li><a href="#summary">Summary</a></li> </ul> <p>In <a href="https://www.devdiaries.net/blog/Prometheus-On-Kubernetes-Part-1/">previous post</a>, you have looked into Prometheus basics. In this part, it is time to create Prometheus service on the Kubernetes which can scrape metrics from additional metric exporter. It’s the perfect solution when you can’t export metrics from the application source code and your application logs the information you want to expose as metrics.</p> <h3 id="example-spring-application-with-logging">Example Spring application with logging</h3> <p>To understand how an gork exporter works, we must first create an application that logs some data to files.</p> <p>I have prepared a very simple application in Spring Boot that has two functionalities:</p> <ol> <li> <p>Welcomes users entering the home page. If the user does not provide his name in <code class="highlighter-rouge">@RequestParam</code> - the application will answer: Hello Guest</p> <p><img src="/images/prometheus-kubernetes/hello.JPG" alt="prometheus-kubernetes-devdiaries" /></p> <p>HelloController source code: <a href="https://github.com/MichalFab/grok-exporter-spring-app/blob/master/src/main/java/net/devdiaries/controller/HelloController.java">Github</a></p> </li> <li> <p>Every 10 seconds creates a log in the form: <strong>DATE TIME SERVICE_NAME CONNECTION_TIME</strong>.</p> </li> </ol> <p><img src="/images/prometheus-kubernetes/times-logs.JPG" alt="prometheus-kubernetes-devdiaries" /></p> <p>Service names are randomly selected from 3 defined names. Response times are also random. The logs are supposed to resemble real logs of the application connecting to other services and measuring the time of connection. The source code is on the <a href="https://github.com/MichalFab/grok-exporter-spring-app/blob/master/src/main/java/net/devdiaries/scheduler/SchedulerTask.java">Github</a></p> <p>Logs are saved to the <code class="highlighter-rouge">logs/applog.log</code> file. Log4j configuration: <img src="/images/prometheus-kubernetes/log4j.JPG" alt="prometheus-kubernetes-devdiaries" /> log4j.xml code: <a href="https://github.com/MichalFab/gork-exporter-spring-app/blob/master/src/main/resources/log4j2.xml">Github</a></p> <p>Application code is also available on <a href="https://github.com/MichalFab/grok-exporter-spring-app">Github</a>, docker image is on <a href="https://cloud.docker.com/u/michf/repository/docker/michf/spring-logging-app">dockerHub</a>.</p> <h3 id="deploy-a-spring-boot-application-on-kubernetes">Deploy a Spring Boot Application on Kubernetes</h3> <p>Firstly, we have to build docker image with application. I have already done it - image is pushed to the DockerHub. You can just import the image in the deployment definition (<code class="highlighter-rouge">image: docker.io/michf/spring-logging-app:latest</code>) for Kubernetes to deploy application.</p> <p>If you want to create an image of your own application you can create a Dockerfile based on <a href="https://github.com/MichalFab/grok-exporter-spring-app/blob/master/Dockerfile">mine</a> and push to the Dockerhub.</p> <p>Now, we have to prepare Kubernetes deployment configuration. Let’s start from the Deployment config:</p> <figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"> 
        <span class="pi">-</span> <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
          <span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
          <span class="na">metadata</span><span class="pi">:</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s">spring-logging-app</span>
            <span class="na">labels</span><span class="pi">:</span>
              <span class="na">app</span><span class="pi">:</span> <span class="s">spring-logging-app</span>
          <span class="na">spec</span><span class="pi">:</span>
            <span class="na">replicas</span><span class="pi">:</span> <span class="s">1</span>
            <span class="na">selector</span><span class="pi">:</span>
              <span class="na">matchLabels</span><span class="pi">:</span>
                <span class="na">app</span><span class="pi">:</span> <span class="s">spring-logging-app</span>
            <span class="na">template</span><span class="pi">:</span>
              <span class="na">metadata</span><span class="pi">:</span>
                <span class="na">labels</span><span class="pi">:</span>
                  <span class="na">app</span><span class="pi">:</span> <span class="s">spring-logging-app</span>
              <span class="na">spec</span><span class="pi">:</span>
                <span class="na">containers</span><span class="pi">:</span>
                  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">spring-logging-app</span>
                    <span class="na">image</span><span class="pi">:</span> <span class="s">docker.io/michf/spring-logging-app:latest</span>
                    <span class="na">ports</span><span class="pi">:</span>
                      <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="s">8080</span></code></pre></figure> <p>Service definition:</p> <figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"> 
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">spring-logging-app</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">ClusterIP</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
      <span class="na">targetPort</span><span class="pi">:</span> <span class="s">8080</span>
      <span class="na">port</span><span class="pi">:</span> <span class="s">8080</span>
    <span class="na">selector</span><span class="pi">:</span>
        <span class="na">sidecar</span><span class="pi">:</span> <span class="s">spring-logging-app</span></code></pre></figure> <p>That’s all. You can deploy logging application on Kubernetes.</p> <h3 id="deploy-a-gork-exporter-as-a-sidecar-on-kubernetes">Deploy a Gork Exporter as a sidecar on Kubernetes</h3> <p>We will be collecting data from our logs using a <strong>sidecar container</strong>. A sidecar container is a secondary container which is run within the same Pod. In our case <code class="highlighter-rouge">gork exporter</code> will be a sidecar container.</p> <p>To configure sidecar pattern, we will create a volume (with /logs path) for our Pod to be shared by all containers in the Pod. Then we will configure gork exporter to read logs from shared location.</p> <p>Firstly, we have to create gork service. Service will be a target in Prometheus:</p> <figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"> 
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">grok-exporter</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">sidecar</span><span class="pi">:</span> <span class="s">grok-exporter</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">ClusterIP</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
      <span class="na">targetPort</span><span class="pi">:</span> <span class="s">9144</span>
      <span class="na">port</span><span class="pi">:</span> <span class="s">9144</span>
    <span class="na">selector</span><span class="pi">:</span>
        <span class="na">sidecar</span><span class="pi">:</span> <span class="s">grok-exporter</span></code></pre></figure> <p>9144 is a default gork exporter port.</p> <h4 id="log-capture-using-gork-exporter-in-kubernetes">Log capture using gork exporter in Kubernetes</h4> <p>To capture logs we need to create a configuration file. For this purpose we will use <code class="highlighter-rouge">ConfigMap</code>:</p> <figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"> 
<span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">grok-exporter</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="s">config.yml</span><span class="pi">:</span> <span class="pi">|-</span>
    <span class="no">global:</span>
      <span class="no">config_version: 2</span>
    <span class="no">input:</span>
      <span class="no">type: file</span>
      <span class="no">fail_on_missing_logfile: false</span>
      <span class="no">path: /logs/applog.log</span>
    <span class="no">grok:</span>
      <span class="no">patterns_dir: ./patterns</span>
    <span class="no">metrics:</span>
      <span class="no">- type: histogram</span>
        <span class="no">name: service_call</span>
        <span class="no">help: Services call times</span>
        <span class="no">match: '%{DATE} %{TIME} %{WORD:service} connection time= %{INT:val}'</span>
        <span class="no">value: ''</span>
    <span class="no">buckets: [100, 1000, 3000]</span>
        <span class="no">labels:</span>
            <span class="no">service    : ''</span>
        <span class="no">- type: counter</span>
            <span class="no">name: hello_requests_total</span>
            <span class="no">help: Hello controller requests counter</span>
            <span class="no">match: '%{DATE} %{TIME} HelloController request from: %{USER:user}'</span>
            <span class="no">labels:</span>
        <span class="no">user    : ''</span>
            <span class="no">server:</span>
            <span class="no">port: 9144</span></code></pre></figure> <p>Configmap will create and mount the <strong>config.yml</strong> file (configuration for gork exporter). In config.yml we set the path to the mounted volume (/logs/applog.log) and two types of metrics. The <a href="https://www.devdiaries.net/blog/Prometheus-On-Kubernetes-Part-1/#histogram"><strong>histogram</strong></a> will inform you about how many connections to external services took less than 100 ms, how many calls took more than 100, but less than 1000, and how many calls lasted more than 3000 ms. <a href="https://www.devdiaries.net/blog/Prometheus-On-Kubernetes-Part-1/#counter"><strong>Counter</strong></a> will inform you how many http requests has served our application for a given user.</p> <p>The <code class="highlighter-rouge">match:</code> property is an expression pattern. You can find all gork patterns on the <a href="https://github.com/logstash-plugins/logstash-patterns-core/blob/master/patterns/grok-patterns">Github</a>. Then you can adjust the pattern to catch your logs.</p> <p>Let’s add volume and gork exporter image to the deployment definition from previous point:</p> <figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"> 
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">spring-logging-app</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">spring-logging-app</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="s">1</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">spring-logging-app</span>
      <span class="na">sidecar</span><span class="pi">:</span> <span class="s">grok-exporter</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">spring-logging-app</span>
        <span class="na">sidecar</span><span class="pi">:</span> <span class="s">grok-exporter</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">spring-logging-app</span>
          <span class="na">image</span><span class="pi">:</span> <span class="s">docker.io/michf/spring-logging-app:latest</span>
          <span class="na">ports</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="s">8080</span>
          <span class="na">volumeMounts</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">logs</span>
              <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/logs/</span>
                <span class="s">- name</span><span class="pi">:</span> <span class="s">grok</span>
          <span class="na">image</span><span class="pi">:</span> <span class="s">palobo/grok_exporter</span>
          <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">Always</span>
          <span class="na">ports</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="s">9144</span>
              <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
          <span class="na">volumeMounts</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">grok-config-volume</span>
              <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/etc/grok_exporter</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">logs</span>
              <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/logs</span>
            <span class="na">volumes</span><span class="pi">:</span>
                <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">grok-config-volume</span>
          <span class="na">configMap</span><span class="pi">:</span>
                <span class="na">name</span><span class="pi">:</span> <span class="s">grok-exporter</span>
                    <span class="s">- name</span><span class="pi">:</span> <span class="s">logs</span>
          <span class="na">emptyDir</span><span class="pi">:</span> <span class="pi">{}</span></code></pre></figure> <p>Now, we can deploy above Deployment. After entering the pod via Kubernetes Dashboard, you should see information about two containers (from gork and from the logging application):</p> <p><img src="/images/prometheus-kubernetes/containers.JPG" alt="kubernetes-login" /></p> <p>Let’s check if gork expese endpoint wiht metrics. I used <code class="highlighter-rouge">kubectl port-forward pod-name port:port</code> to forward a gork port to localhost</p> <figure class="highlight"><pre><code class="language-sh" data-lang="sh"> 

kubectl port-forward spring-logging-app-79bb56876-c4h29 9144:9144     </code></pre></figure> <hr /> <p>You can go to <code class="highlighter-rouge">127.0.0.1:9144/metrics</code> and check the application metrics based on the logs:.</p> <p>Counter metrics:</p> <p><img src="/images/prometheus-kubernetes/hello-counter.JPG" alt="kubernetes-login" /></p> <p>Histogram metrics:</p> <p><img src="/images/prometheus-kubernetes/histogram.JPG" alt="kubernetes-login" /></p> <h3 id="deploy-a-prometheus-on-kubernetes">Deploy a Prometheus on Kubernetes</h3> <h4 id="prometheus-configmap">Prometheus ConfigMap</h4> <p>Firstly, create a configmap with the Prometheus scrape config:</p> <figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"> 
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">prometheus</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="s">prometheus.yml</span><span class="pi">:</span> <span class="pi">|-</span>
    <span class="no">global:</span>
      <span class="no">scrape_interval: 15s</span>
    <span class="no">scrape_configs:</span>
    <span class="no">- job_name: 'grok'</span>
      <span class="no">static_configs:</span>
      <span class="no">- targets: ['grok-exporter:9144']</span></code></pre></figure> <p>Prometheus will collect information from the gork-exporter service every 15 seconds.</p> <h4 id="prometheus-deployment">Prometheus Deployment</h4> <p>In Prometheus deployment config We have to mount created a moment ago config map as a file inside <code class="highlighter-rouge">/etc/prometheus</code>:</p> <figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"> 
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">prometheus</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">prometheus</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="s">1</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">prometheus</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">prometheus</span>
          <span class="na">image</span><span class="pi">:</span> <span class="s">prom/prometheus:v2.12.0</span>
          <span class="na">ports</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">web</span>
              <span class="na">containerPort</span><span class="pi">:</span> <span class="s">9090</span>
          <span class="na">volumeMounts</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">prometheus-config</span>
              <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/etc/prometheus</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">prometheus-data</span>
              <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/prometheus</span>
            <span class="na">volumes</span><span class="pi">:</span>
                <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">prometheus-data</span>
          <span class="na">emptyDir</span><span class="pi">:</span> <span class="pi">{}</span>
                    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">prometheus-config</span>
          <span class="na">configMap</span><span class="pi">:</span>
                  <span class="na">name</span><span class="pi">:</span> <span class="s">prometheus</span></code></pre></figure> <h4 id="prometheus-service">Prometheus Service</h4> <p>To acces the Prometheus GUI over an IP/DNS, we need to expose it as a service:</p> <figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"> 
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">prometheus</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">prometheus</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">prometheus</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">NodePort</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">web</span>
      <span class="na">nodePort</span><span class="pi">:</span> <span class="s">31199</span>
      <span class="na">port</span><span class="pi">:</span> <span class="s">9090</span>
      <span class="na">targetPort</span><span class="pi">:</span> <span class="s">9090</span></code></pre></figure> <h3 id="summary">Summary</h3> <p>Now we can access the Prometheus dashboard using kubectl port-forward <pod name=""> 9090:9090. You should see the Prometheus dashboard with scraped data:</pod></p> <p><img src="/images/prometheus-kubernetes/scraped-data.JPG" alt="kubernetes-login" /></p> <p>Thank you for reading! I hope you enjoyed the post.</p> </article> <hr class="dashed"><div class="row rev"><div class="col-md-12"><div class="share-box"> <i class="fa fa-share-alt" aria-hidden="true"></i> <a class="f nostyle" href="https://www.facebook.com/sharer/sharer.php?u=https://www.devdiaries.net/blog/Prometheus-On-Kubernetes-Part-2/" onclick="window.open(this.href, 'mywin', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" ><i class="fa fa-facebook-official fa"></i></a> <a class="t nostyle" href="https://twitter.com/intent/tweet?text=&url=https://www.devdiaries.net/blog/Prometheus-On-Kubernetes-Part-2/" onclick="window.open(this.href, 'mywin', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"><i class="fa fa-twitter fa"></i></a> <a class="g nostyle" href="https://plus.google.com/share?url=https://www.devdiaries.net/blog/Prometheus-On-Kubernetes-Part-2/" onclick="window.open(this.href, 'mywin', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" ><i class="fa fa-google-plus fa"></i></a> <a class="r nostyle" href="http://www.reddit.com/submit?url=https://www.devdiaries.net/blog/Prometheus-On-Kubernetes-Part-2/" onclick="window.open(this.href, 'mywin', 'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;" ><i class="fa fa-reddit fa"></i></a> <a class="l nostyle" href="https://www.linkedin.com/shareArticle?mini=true&url=https://www.devdiaries.net/blog/Prometheus-On-Kubernetes-Part-2/&title=&summary=&source=dev-diary.github.io" onclick="window.open(this.href, 'mywin', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" ><i class="fa fa-linkedin fa"></i></a> <a class="e nostyle" href="mailto:?subject=&amp;body=Check&amp;out&amp;this&amp;site&amp;https://www.devdiaries.net/blog/Prometheus-On-Kubernetes-Part-2/"><i class="fa fa-envelope fa"></i></a></div></div></div><div class="row"><div class="col-md-12"> <p class="categories rev"> <span><a href="/categories/#kubernetes">Kubernetes</a></span> <span><a href="/categories/#prometheus">Prometheus</a></span></p></div></div><div id="disqus_thread"></div><script> var disqus_config = function () { this.page.url = 'https://www.devdiaries.net/blog/Prometheus-On-Kubernetes-Part-2/'; this.page.identifier = 'https://www.devdiaries.net/blog/Prometheus-On-Kubernetes-Part-2/'; }; (function() { var d = document, s = d.createElement('script'); s.src = 'https://dev-diary-2.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })();</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> <!--<div class="comment-loader">--> <!--<button class="comments cards">Comments</button>--> <!--</div>--> <!--<div class="disqus hide">Loading comments&hellip;</div>--> <!--<div class="disqus-loading"></div>--> <!--<script>--> <!--/*--> <!-- disqusLoader.js v1.0--> <!-- A JavaScript plugin for lazy-loading Disqus comments widget.--> <!-- - --> <!-- By Osvaldas Valutis, www.osvaldas.info--> <!-- Available for use under the MIT License--> <!--*/--> <!--(function(b,f,l){var r=function(a){a=a.getBoundingClientRect();return{top:a.top+f.body.scrollTop,left:a.left+f.body.scrollLeft}},t=function(a,c){var d=f.createElement("script");d.src=a;d.async=!0;d.setAttribute("data-timestamp",+new Date);d.addEventListener("load",function(){"function"===typeof c&&c()});(f.head||f.body).appendChild(d)};l=function(a,c){var d,e;return function(){var g=this,f=arguments,b=+new Date;d&&b<d+a?(clearTimeout(e),e=setTimeout(function(){d=b;c.apply(g,f)},a)):(d=b,c.apply(g,--> <!--f))}};var m=!1,n=!1,p=!1,k=!1,h="unloaded",e=!1,q=function(){if(!e||!f.body.contains(e)||"loaded"==e.disqusLoaderStatus)return!0;var a=b.pageYOffset,c=r(e).top;if(c-a>b.innerHeight*n||0<a-c-e.offsetHeight-b.innerHeight*n)return!0;(a=f.getElementById("disqus_thread"))&&a.removeAttribute("id");e.setAttribute("id","disqus_thread");e.disqusLoaderStatus="loaded";"loaded"==h?DISQUS.reset({reload:!0,config:p}):(b.disqus_config=p,"unloaded"==h&&(h="loading",t(k,function(){h="loaded"})))};b.addEventListener("scroll",--> <!--l(m,q));b.addEventListener("resize",l(m,q));b.disqusLoader=function(a,c){var d={laziness:1,throttle:250,scriptUrl:!1,disqusConfig:!1},b=c,g,h={};for(g in d)Object.prototype.hasOwnProperty.call(d,g)&&(h[g]=d[g]);for(g in b)Object.prototype.hasOwnProperty.call(b,g)&&(h[g]=b[g]);c=h;n=c.laziness+1;m=c.throttle;p=c.disqusConfig;k=!1===k?c.scriptUrl:k;e="string"===typeof a?f.querySelector(a):"number"===typeof a.length?a[0]:a;e.disqusLoaderStatus="unloaded";q()}})(window,document,0);--> <!--</script>--> <!--<script>--> <!-- disqusLoader( '.disqus',--> <!-- {--> <!-- scriptUrl: '//{"shortname"=>"dev-diary-2"}.disqus.com/embed.js',--> <!-- disqusConfig: function()--> <!-- {--><script src="//ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script><script> $(document).ready(function () { $(".loader").hide(); });</script><script> $("#search-input").keyup(function () { $("main").hide(); $("search-container").show(); if (!$('#search-input').val()) { $("main").show(); $("search-container").hide(); } });</script><script src="/js/jekyll-search.min.js" type="text/javascript"></script><script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-container'), searchResultTemplate: '<a class="nostyle" href="{url}"><div class="blog borders cards"><div class="image" style="background-image: url({image});"></div><div class="content"><h3 class="title">{title}</h3><p class="description">{description}</p></div></div></a>', noResultsText: 'No results found', json: '/search.json' })</script><script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script><script> AOS.init({ duration: 600, once: true, disable: 'mobile' });</script><script> $("button").click(function () { $(".disqus").toggle(); $(".comments").toggle(); });</script></body></html>